var GeoMashupLocationEditor,geo_mashup_location_editor;geo_mashup_location_editor=GeoMashupLocationEditor={object_id:null,map:null,mapCreated:new mxn.Event("mapCreated",this),loaded:new mxn.Event("loaded",this),markerCreated:new mxn.Event("markerCreated",this),markerSelected:new mxn.Event("markerSelected",this)};jQuery(function(D){var o=geo_mashup_location_editor_settings.geo_mashup_url_path,g=geo_mashup_location_editor_settings.ajax_url,B=D("#geo_mashup_object_id").val(),F=false,a,e,v,y,R,t,u=D("#geo-mashup-inline-help-link"),P=D("#geo_mashup_add_location"),p=D("#geo_mashup_update_location"),L=D("#geo_mashup_delete_location"),V=D("#geo_mashup_changed"),l=D("#geo_mashup_location_name"),f=D("#geo_mashup_location"),c=D("#geo_mashup_location_id"),s=D("#geo_mashup_geoname"),N=D("#geo_mashup_address"),q=D("#geo_mashup_postal_code"),x=D("#geo_mashup_country_code"),C=D("#geo_mashup_admin_code"),G=D("#geo_mashup_admin_name"),A=D("#geo_mashup_sub_admin_code"),E=D("#geo_mashup_sub_admin_name"),W=D("#geo_mashup_kml_url"),M=D("#geo_mashup_locality_name"),n=D("#geo_mashup_display"),j=n.find(".geo-mashup-info"),m=n.find(".geo-mashup-address"),k=n.find(".geo-mashup-coordinates"),r=D("#geo_mashup_saved_name_ui"),z=D("#geo_mashup_date_ui"),K=D("#geo_mashup_ajax_message"),i=function(X){this.id=null;this.title="";this.geoname="";this.country_code="";this.admin_code="";this.admin_name="";this.sub_admin_code="";this.sub_admin_name="";this.postal_code="";this.locality_name="";this.address="";this.definedValue=function(Z,Y){if(typeof Z==="undefined"){return Y}else{return Z}};this.subValue=function(ab,aa,Y){var Z;if(typeof Y!=="string"){Y=""}if(typeof ab!=="object"){return Y}if(typeof aa!=="object"){return Y}if(typeof aa.length!=="number"){return Y}Z=aa.shift();if(typeof ab[Z]==="undefined"){return Y}if(aa.length===0){return ab[Z]}return this.subValue(ab[Z],aa,Y)};this.set=function(aa){var Z,Y;if(typeof aa==="string"){if(isNaN(aa)){this.title=aa}else{this.id=aa}}else{if(typeof aa==="number"){this.id=aa}else{if(typeof aa==="object"){if(typeof aa.location_id==="string"){this.id=aa.location_id;this.title=aa.name;this.address=aa.address}else{if(typeof aa.name==="string"){this.id="";this.title=aa.name;this.geoname=aa.name;this.country_code=this.definedValue(aa.countryCode,"");this.admin_code=this.definedValue(aa.adminCode1,"");this.admin_name=this.definedValue(aa.adminName1,"");this.sub_admin_code=this.definedValue(aa.adminCode2,"");this.sub_admin_name=this.definedValue(aa.adminName2,"");this.address=this.title+", "+this.admin_name+", "+this.country_code}else{if(typeof aa.address==="string"){this.title=aa.address;this.address=aa.address;this.country_code=this.subValue(aa,["AddressDetails","Country","CountryNameCode"]);this.admin_code=this.subValue(aa,["AddressDetails","Country","AdministrativeArea","AdministrativeAreaName"]);this.sub_admin_name=this.subValue(aa,["AddressDetails","Country","AdministrativeArea","SubAdministrativeArea","SubAdministrativeAreaName"]);if(this.sub_admin_name){this.locality_name=this.subValue(aa,["AddressDetails","Country","AdministrativeArea","SubAdministrativeArea","Locality","LocalityName"]);this.postal_code=this.subValue(aa,["AddressDetails","Country","AdministrativeArea","SubAdministrativeArea","Locality","PostalCode","PostalCodeNumber"])}else{if(this.admin_code){this.locality_name=this.subValue(aa,["AddressDetails","Country","AdministrativeArea","Locality","LocalityName"]);this.postal_code=this.subValue(aa,["AddressDetails","Country","AdministrativeArea","Locality","PostalCode","PostalCodeNumber"])}}if(this.admin_code.length>20||this.admin_code.indexOf(" ")>=0){this.admin_name=this.admin_code;this.admin_code=""}}else{if(typeof aa.types==="object"){this.title=aa.formatted_address;this.address=aa.formatted_address;for(Z=0;Z<aa.address_components.length;Z+=1){Y=aa.address_components[Z].types.join("|");if(Y.indexOf("country")>=0){this.country_code=aa.address_components[Z].short_name}else{if(Y.indexOf("administrative_area_level_1")>=0){this.admin_code=aa.address_components[Z].short_name;this.admin_name=aa.address_components[Z].long_name}else{if(Y.indexOf("administrative_area_level_2")>=0){this.sub_admin_code=aa.address_components[Z].short_name;this.sub_admin_name=aa.address_components[Z].long_name}else{if(Y.indexOf("locality")>=0){this.locality_name=aa.address_components[Z].short_name}else{if(Y.indexOf("postal_code")>=0){this.postal_code=aa.address_components[Z].short_name}}}}}}if(this.admin_code.length>20||this.admin_code.indexOf(" ")>=0){this.admin_name=this.admin_code;this.admin_code=""}}}}}}}}};if(X){this.set(X)}},T=(function(){var Z=D("#geo_mashup_select"),X=Z.get(0),Y=null,ab=null,aa=function(){var ac,ad;if(X.selectedIndex>0){ac=X.options[X.selectedIndex];ad=ac.value.split("|");if(ad.length>2){ab={location_id:ad[0],name:ac.text,address:ad[3]};Y=new mxn.LatLonPoint(parseFloat(ad[1]),parseFloat(ad[2]));l.val(ac.text)}}};Z.change(function(){ab=Y=null;aa();if(Y){S(Y,ab)}});return{getSelectedID:function(){if(ab){return ab.location_id}else{return null}},getSelectedLatLng:function(){return Y},getSelectedLocation:function(){return ab},selectNone:function(){X.selectedIndex=0},selectByID:function(ad){var ac;if(!X.options||!X.options.length){return false}for(ac=1;ac<X.options.length;ac+=1){if(ac!==X.selectedIndex&&X.options[ac].value.indexOf(ad+"|")===0){X.selectedIndex=ac;aa();return true}}this.selectNone();return false},selectByText:function(ad){var ac;if(!X.options||!X.options.length){return false}if(typeof ad!=="string"){ad=ad.toString()}for(ac=1;ac<X.options.length;ac+=1){if(ac!==X.selectedIndex&&X.options[ac].text===ad){X.selectedIndex=ac;aa();return true}}this.selectNone();return false}}}()),O=function(){var X,Z,Y;a={image:o+"/images/mm_20_red.png",shadow:o+"/images/mm_20_shadow.png",iconSize:[12,20],shadowSize:[22,20],iconAnchor:[6,20],infoWindowAnchor:[5,1]};e={image:o+"/images/mm_20_green.png",shadow:o+"/images/mm_20_shadow.png",iconSize:[12,20],shadowSize:[22,20],iconAnchor:[6,20],infoWindowAnchor:[5,1]};Y=D("#geo_mashup_map").empty();t=D('<div id="gm-loading-icon" style="-moz-user-select: none; z-index: 100; position: absolute; left: '+(Y.width()/2)+"px; top: "+(Y.height()/2)+'px;"><img style="border: 0px none ; margin: 0px; padding: 0px; width: 16px; height: 16px; -moz-user-select: none;" src="'+o+'/images/busy_icon.gif"/></a></div>');Y.append(t);geo_mashup_location_editor.map=y=new mxn.Mapstraction(Y.get(0),geo_mashup_location_editor_settings.map_api);y.setOptions({enableDragging:true,enableScrollWheelZoom:true});y.addControls({zoom:"small",map_type:true});geo_mashup_location_editor.showBusyIcon();y.load.addHandler(function(){geo_mashup_location_editor.hideBusyIcon()},y);y.setCenterAndZoom(new mxn.LatLonPoint(0,0),2);if(typeof y.enableGeoMashupExtras==="function"){y.enableGeoMashupExtras()}geo_mashup_location_editor.mapCreated.fire();if(W.val().length>0){geo_mashup_location_editor.loadKml(W.val())}if(f.val().indexOf(",")>0){X=f.val().split(",");if(X.length>1){Z=new mxn.LatLonPoint(parseFloat(X[0]),parseFloat(X[1]));f.val(Z.toString());S(Z,{location_id:c.val(),name:l.val()})}}y.click.addHandler(b,y);geo_mashup_location_editor.loaded.fire()},d=function(Z,Y){var X=Z.toString();if((c.val()!==Y.id)||(f.val()!==X)){if(T.getSelectedID()!==Y.id){T.selectByID(Y.id)}c.val(Y.id||"");f.val(X);s.val(Y.geoname);N.val(Y.address);q.val(Y.postal_code);x.val(Y.country_code);C.val(Y.admin_code);G.val(Y.admin_name);A.val(Y.sub_admin_code);E.val(Y.sub_admin_name);M.val(Y.locality_name);m.text(Y.address);k.text(Z.toString());j.addClass("ui-state-highlight");geo_mashup_location_editor.setHaveUnsavedChanges()}},h=function(ab,aa){var X,Y,Z={label:aa.title,icon:a.image,iconSize:e.iconSize,iconShadow:e.iconShadow,iconAnchor:e.iconAnchor,iconShadowSize:e.shadowSize};X=new mxn.Marker(ab);X.addData(Z);X.geo_mashup_location=aa;X.click.addHandler(function(){U(X)});if(!v){Z.icon=e.image;Z.draggable=true;X.addData(Z);v=X;y.setCenter(ab);d(ab,aa);Y={marker:X};geo_mashup_location_editor.markerSelected.fire(Y);X=Y.marker}Y={marker:X};geo_mashup_location_editor.markerCreated.fire(Y);y.addMarker(Y.marker);if(Y.marker.dragend){Y.marker.dragend.addHandler(function(ad,ae,ac){aa.id="";d(ac.location,aa);y.setCenter(ac.location)})}return Y.marker},U=function(X){if(X!==v){h(v.location,v.geo_mashup_location);y.removeMarker(v);v=null;h(X.location,X.geo_mashup_location);y.removeMarker(X)}y.setCenter(X.location)},S=function(Z,Y){var X=h(Z,new i(Y));U(X)},b=function(Y,Z,X){if(X){I(X.location.toString())}},w=function(Z,Y){var aa,ac,X,ab;if(Z&&typeof Y!=="undefined"&&google.maps.GeocoderStatus.OK===Y){for(aa=0;aa<Z.length&&aa<20&&Z[aa].geometry;aa+=1){ac=new mxn.LatLonPoint(Z[aa].geometry.location.lat(),Z[aa].geometry.location.lng());X=h(ac,new i(Z[aa]))}}else{if(typeof Y==="undefined"&&Z&&200===Z.Status.code&&Z.Placemark&&Z.Placemark.length>0){for(aa=0;aa<Z.Placemark.length&&aa<20&&Z.Placemark[aa];aa+=1){ac=new mxn.LatLonPoint(Z.Placemark[aa].Point.coordinates[1],Z.Placemark[aa].Point.coordinates[0]);X=h(ac,new i(Z.Placemark[aa]))}}else{ab="http://api.geonames.org/search?type=json&maxRows=20&style=full&callback=?&username="+geo_mashup_location_editor_settings.geonames_username+"&name="+encodeURIComponent(D("#geo_mashup_search").val());jQuery.getJSON(ab,Q);geo_mashup_location_editor.showBusyIcon()}}},Q=function(aa){var Y,Z,X;if(aa){for(Y=0;Y<aa.geonames.length&&Y<100&&aa.geonames[Y];Y+=1){Z=new mxn.LatLonPoint(aa.geonames[Y].lat,aa.geonames[Y].lng);X=h(Z,new i(aa.geonames[Y]))}geo_mashup_location_editor.hideBusyIcon()}},I=function(X){var ab,Y,aa,ac=null,Z;y.removeAllMarkers();v=null;f.val("");geo_mashup_location_editor.setHaveUnsavedChanges();T.selectNone();if(T.selectByText(X)){S(T.getSelectedLatLng(),T.getSelectedLocation())}else{if(X.match(/^[\-\d\.\s]*,[\-\d\.\s]*$/)){aa=X.split(",");ac=new mxn.LatLonPoint(parseFloat(aa[0]),parseFloat(aa[1]));S(ac)}if(typeof google==="object"&&typeof google.maps==="object"){geo_mashup_location_editor.showBusyIcon();if(typeof google.maps.Geocoder==="function"){ab=new google.maps.Geocoder();Z=y.getBounds();Y={bounds:new google.maps.LatLngBounds(new google.maps.LatLng(Z.getSouthWest().lat,Z.getSouthWest().lng),new google.maps.LatLng(Z.getNorthEast().lat,Z.getNorthEast().lng))};if(ac){Y.latLng=new google.maps.LatLng(ac.lat,ac.lng)}else{Y.address=X}ab.geocode(Y,w)}else{if(typeof google.maps.ClientGeocoder==="function"){ab=new google.maps.ClientGeocoder();geo_mashup_location_editor.showBusyIcon();Z=y.getBounds();ab.setViewport(new google.maps.LatLngBounds(new google.maps.LatLng(Z.getSouthWest().lat,Z.getSouthWest().lng),new google.maps.LatLng(Z.getNorthEast().lat,Z.getNorthEast().lng)));ab.getLocations(X,w)}}}else{if(ac){geonames_request_url="http://api.geonames.org/findNearbyJSON?radius=50&style=full&callback=?&username="+geo_mashup_location_editor_settings.geonames_username+"&lat="+ac.lat+"&lng="+ac.lng}else{geonames_request_url="http://api.geonames.org/search?type=json&maxRows=20&style=full&callback=?&username="+geo_mashup_location_editor_settings.geonames_username+"&q="+encodeURIComponent(D("#geo_mashup_search").val())}jQuery.getJSON(geonames_request_url,Q);geo_mashup_location_editor.showBusyIcon()}}},H=function(Y,X){if((Y.keyCode&&Y.keyCode===13)||(Y.which&&Y.which===13)){I(X);return false}else{return true}},J=function(){F=false;V.val("")};geo_mashup_location_editor.object_id=B;geo_mashup_location_editor.map=y;geo_mashup_location_editor.getSelectedLatLngs=function(){var X=[];if(v){X.push(v.location)}return X};geo_mashup_location_editor.setHaveUnsavedChanges=function(){F=true;V.val("true");if(B>0){p.show()}K.hide()};geo_mashup_location_editor.getHaveUnsavedChanges=function(){return F};geo_mashup_location_editor.loadKml=function(X){var Y=function(){y.endPan.removeHandler(Y,null);S(y.getCenter(),{location_id:c.val(),name:l.val()})};if(f.val().length===0){y.endPan.addHandler(Y,null)}y.addOverlay(X,true)};geo_mashup_location_editor.showBusyIcon=function(){t.show()};geo_mashup_location_editor.hideBusyIcon=function(){t.hide()};D(".geo-mashup-js").removeClass("geo-mashup-js");K.hide();D("#geo_mashup_no_js").val("");u.click(function(){D(this).find("span").toggleClass("ui-icon-triangle-1-s").toggleClass("ui-icon-triangle-1-n");D("#geo-mashup-inline-help").slideToggle();return false});D("#geo-mashup-inline-help").hide().click(function(){return u.click()});if(typeof D.datepicker==="object"){D("#geo_mashup_date").datepicker({dateFormat:"M d, yy",changeYear:true,onSelect:function(X,Y){geo_mashup_location_editor.setHaveUnsavedChanges();z.addClass("ui-state-highlight")}})}else{D("#geo_mashup_date").change(function(){geo_mashup_location_editor.setHaveUnsavedChanges();z.addClass("ui-state-highlight")})}D("#geo_mashup_hour").change(function(){geo_mashup_location_editor.setHaveUnsavedChanges();z.addClass("ui-state-highlight")});D("#geo_mashup_minute").change(function(){geo_mashup_location_editor.setHaveUnsavedChanges();z.addClass("ui-state-highlight")});l.keypress(function(){if(!geo_mashup_location_editor.getHaveUnsavedChanges()){geo_mashup_location_editor.setHaveUnsavedChanges();T.selectNone();r.addClass("ui-state-highlight")}});D("#geo_mashup_search").focus(function(){var X=D("#geo_mashup_map");this.select();y.resizeTo(X.width(),X.height())}).keypress(function(X){return H(X,this.value)});O();K.ajaxError(function(Z,Y,X){if(X&&X.data&&X.data.toString().indexOf("geo_mashup")>=0){K.text(Y.statusText+": "+Y.responseText).show()}});D("#geo_mashup_submit").appendTo("#geo_mashup_ajax_buttons");L.click(function(){var X;f.val("");X=D("#geo_mashup_location_editor input").serialize()+"&geo_mashup_delete_location=true&action=geo_mashup_edit";K.hide();D.post(g,X,function(Y){K.html(Y.status.message).fadeIn("slow");if(200===Y.status.code){J();n.find(".ui-state-highlight").removeClass("ui-state-highlight");y.removeAllMarkers();v=null;T.selectNone();m.text("");k.text("");l.val("");L.hide();p.hide()}},"json");return false});p.click(function(){var X=D("#geo_mashup_location_editor input").serialize()+"&geo_mashup_update_location=true&action=geo_mashup_edit";K.hide();D.post(g,X,function(Y){K.html(Y.status.message).fadeIn("slow");if(200===Y.status.code){J();n.find(".ui-state-highlight").removeClass("ui-state-highlight");p.hide()}},"json");return false});P.hide();if(!F){p.hide()}if(!B){L.hide()}});